<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flask Bootstrap App</title>
    <link href="{{ url_for('static',filename='styles/main.css') }}" rel="stylesheet">
    
</head>
<body>
    <h1 class="text-center">The Bot for <span class="text-primary" id="element"></span></h1>
    
    <div class="d-flex justify-content-center align-items-center" style="height: 30vh;">
        <button class="btn btn-primary text-white " id="openModalBtn">Create new request!</button>
    </div>
    <hr class="m-3">
    <!-- Div containing requests -->
    <div class="requests">
    </div>

    <!-- Demo request -->
    <div class="bg-secondary p-2 rounded m-4 text-white d-flex justify-content-between">
        <div class="d-flex justify-content-between">
            <div>
                <h2 class="fw-bold fst-italic">${request.name}</h2>
                <hr>
                ${statusIndicator}
            </div>
            <div class="ms-2">
                <p><span class="fw-bold">Room:</span> <span>${request.room}</span></p>
                <p><span class="fw-bold">Type:</span> <span>${request.type}</span></p>
                <p><span class="fw-bold">Medicine:</span> <span>${request.medicine}</span></p>
            </div>

        </div>
        <div class="d-flex align-items-center">
            ${send_button}
        </div>
    </div>

    <!-- Modal create req -->
    <div class="modal fade" id="requestModal" tabindex="-1" aria-labelledby="requestModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="requestModalLabel">Add Request</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="nameInput" class="form-label">Patient name</label>
                        <input type="text" class="form-control" id="nameInput">
                    </div>
                    <div class="mb-3">
                        <label for="roomInput" class="form-label">Room</label>
                        <select class="form-select" id="roomInput">
                            <option value="1">1</option>
                            <option value="2">2</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="typeInput" class="form-label">Type</label>
                        <select class="form-select" id="typeInput">
                            <option value="collection">collection</option>
                            <option value="delivery">delivery</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="medicineInput" class="form-label">Medicine</label>
                        <select class="form-select" id="medicineInput">
                            <option value="sleeping pills">sleeping pills</option>
                            <option value="painkiller">painkiller</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary text-white " id="confirmBtn">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal confirm that done -->
    <div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmationModalLabel">Confirmation</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Robot ready to go back?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary">No</button>
                    <button type="button" class="btn btn-primary" id="yesButton">Yes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Imported Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/socket.io/client-dist/socket.io.min.js"></script>
    <script src="https://unpkg.com/typed.js@2.1.0/dist/typed.umd.js"></script>

    <script>
        function reloadRequests() {
            fetch('/api', {
                method: 'GET'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch requests');
                }
                return response.json();
            })
            .then(data => {
                var requestsDiv = document.querySelector('.requests');
                var currentPath = window.location.pathname;

                requestsDiv.innerHTML = ''; // Clear the existing requests

                if (data.length === 0) {
                    // If data array is empty, add a centered paragraph saying "No requests added"
                    requestsDiv.innerHTML = `
                        <div class="text-center">
                            <p>No requests added</p>
                        </div>
                    `;
                } else {
                    // Otherwise, iterate through the data and display each request
                    data.forEach(request => {
                        var statusIndicator = '';
                        var send_button = '';
                        

                        switch (request.status) {
                            case 'pending':
                                statusIndicator = `<span class="badge text-bg-warning ms-2">pending</span>`;
                                break;
                            case 'in progress':
                                statusIndicator = `<span class="badge text-bg-danger mx-2">in progress</span> <div class="spinner-border text-white" role="status"><span class="sr-only"></span></div>`;
                                break;
                            case 'done':
                                statusIndicator = `<span class="badge text-bg-success ms-2">done</span>`;
                                break;
                            default:
                                statusIndicator = `<span class="badge text-bg-dark ms-2">unknown</span>`;
                                break;
                        }

                        if (currentPath === '/admin') {
                            send_button = `<button type="button" class="send-robot btn btn-danger" data-request-id="${request.id}">Send robot</button>`
                        }

                        var requestHtml = `
                        <div class="bg-secondary p-2 rounded m-3 text-white d-flex justify-content-between hover-effect">
                            <div>
                                <div class="d-flex align-items-center">
                                    <h2 class="fw-bold fst-italic">${request.name}</h2>
                                    ${statusIndicator}
                                </div>
                                <p><span class="fw-bold">Room:</span> <span>${request.room}</span></p>
                                <p><span class="fw-bold">Type:</span> <span>${request.type}</span></p>
                                <p><span class="fw-bold">Medicine:</span> <span>${request.medicine}</span></p>
                            </div>
                            <div  class="d-flex align-items-center">
                                ${send_button}
                            </div>
                        </div>
                        `;

                        requestsDiv.innerHTML += requestHtml;

                        
                    });
                    var collection = document.getElementsByClassName("send-robot");
                    collection = Array.from(collection);
                        collection.forEach(function(button) {
                            button.addEventListener('click', function() {
                                requestId = button.dataset.requestId;
                                req = fetch(`/api/request?id=${requestId}`, {
                                    method: 'GET'
                                })
                                .then(response => {
                                    if (!response.ok) {
                                        throw new Error('Failed to fetch request');
                                    }
                                    return response.json();
                                })
                                .then(data => {
                                    console.log('Request:', data);
                                    send_robot(data["room"]);
                                    
                                })
                                .catch(error => {
                                    console.error('Error:', error);
                                    // Handle error
                                });


                                // Update the request to in progress
                                fetch(`/api/update_req?id=${requestId}&status=in progress`, {
                                    method: 'POST'
                                })
                                .then(response => {
                                    if (!response.ok) {
                                        throw new Error('Failed to send request');
                                    }
                                    return response.json();
                                })
                                .then(data => {
                                    console.log(data); // Log any response data
                                    // Handle success
                                })
                                .catch(error => {
                                    console.error('Error:', error);
                                    // Handle error
                                });
                                
                                function send_robot(room){
                                    // Send the robot
                                    fetch(`/api/send_robot?room_id=${room}`, {
                                        method: 'PUT'
                                    })
                                    .then(response => {
                                        if (!response.ok) {
                                            throw new Error('Failed to send request');
                                        }
                                        return response.json();
                                    })
                                    .then(data => {
                                        var modal = new bootstrap.Modal(document.getElementById('confirmationModal'), {
                                            keyboard: false
                                        });
                                        modal.show();
                                    })
                                    .catch(error => {
                                        console.error('Error:', error);
                                        // Handle error
                                    });
                                }
                            });
                        });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // Handle error
            });

            
        }

        function send_home(){
            console.log("SEND HOME")
            fetch(`/api/send_robot?room_id=0`, {
                method: 'PUT'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to send request');
                }
                return response.json();
            })
            .then(data => {
                fetch(`/api/update_req?id=${requestId}&status=done`, {
                    method: 'POST'
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to send request');
                    }
                    return response.json();
                })
                .then(data => {
                    
                })
                .catch(error => {
                    console.error('Error:', error);
                    // Handle error
                });
            })
            .catch(error => {
                console.error('Error:', error);
                // Handle error
            });
        }
        
        function openModalButtonListener(){
            var modal = new bootstrap.Modal(document.getElementById('requestModal'), {
                keyboard: false
            });
            modal.show();
        }

        function confirmCreateRequestButtonListener(){
            var name = document.getElementById('nameInput').value;
            var room = document.getElementById('roomInput').value;
            var type = document.getElementById('typeInput').value;
            var medicine = document.getElementById('medicineInput').value;
            
            
            // Create a new request object
            var request = {
                name: name,
                room: room,
                type: type,
                medicine: medicine
            };

            // Send a PUT request to add the new request
            fetch('/api/request', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(request)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to add request');
                }
                return response.json();
            })
            .then(data => {
                var modal = bootstrap.Modal.getInstance(document.getElementById('requestModal'));
                modal.hide();
            })
            .catch(error => {
                console.error('Error:', error);
                // Handle error
            });
        }

        function registerSocketEvents(){
            // Connect to the SocketIO server
            var socket = io();

            // Listen for the 'new_request' event
            socket.on('new_request', function(request) {
                reloadRequests();
            });
        }

        function requestTypeChangeListener(typeInput, medicineInput){
            console.log("TEST");
            // If the selected value is "delivery", enable the medicineInput, otherwise disable it
            if (typeInput.value === "delivery") {
                medicineInput.disabled = false;
            } else {
                medicineInput.disabled = true;
            }
        }

        function sendHomeYesButtonListener(){
            var modal = bootstrap.Modal.getInstance(document.getElementById('confirmationModal'));
            modal.hide();
            console.log("send");
            send_home();
        }

        function headline_animation(){
            var typed = new Typed('#element', {
            strings: ['Lieferung', 'Abholung', 'Pflege.'],
            typeSpeed: 100,
            backSpeed: 150,
            backDelay: 700,
            startDelay: 800
            });
        }

        document.getElementById('openModalBtn').addEventListener('click', function(){
            openModalButtonListener();
        });

        document.getElementById('confirmBtn').addEventListener('click', function(){
            confirmCreateRequestButtonListener();
        });
        
        var typeInput = document.getElementById("typeInput");

        typeInput.addEventListener("change", function(){
            var medicineInput = document.getElementById("medicineInput");
            requestTypeChangeListener(typeInput, medicineInput);
        });

        document.getElementById('yesButton').addEventListener('click', function() {
            sendHomeYesButtonListener();
        });

        medicineInput.disabled = true;

        registerSocketEvents();
        reloadRequests();
        headline_animation();
    </script>
</body>
</html>
